name: Test DevContainer

on:
  push:
    branches:
      - main
    paths:
      - '.devcontainer/**'
      - 'src/firewall/**'
  pull_request:
    branches:
      - main
    paths:
      - '.devcontainer/**'
      - 'src/firewall/**'
  workflow_dispatch:

jobs:
  build-devcontainer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Build devcontainer
        run: |
          devcontainer build --workspace-folder .

      - name: Test devcontainer starts
        run: |
          devcontainer up --workspace-folder .

      - name: Verify firewall scripts installed
        run: |
          devcontainer exec --workspace-folder . bash -c "
            echo '=== Verifying firewall installation ==='

            # Check scripts exist
            test -f /usr/local/bin/firewall-entrypoint.sh && echo '✓ firewall-entrypoint.sh exists'
            test -f /usr/local/bin/init-firewall.sh && echo '✓ init-firewall.sh exists'
            test -f /usr/local/bin/disable-firewall.sh && echo '✓ disable-firewall.sh exists'
            test -x /usr/local/bin/firewall && echo '✓ firewall command exists'

            # Check config
            test -f /etc/firewall.conf && echo '✓ firewall.conf exists'
            grep -q 'FIREWALL_ENABLE_ON_START' /etc/firewall.conf && echo '✓ entrypoint settings in config'

            # Check scoped sudoers
            test -f /etc/sudoers.d/firewall-feature && echo '✓ scoped sudoers exists'

            # Check custom entrypoint
            test -f /usr/local/bin/entrypoint.sh && echo '✓ custom entrypoint exists'
            test -f /etc/sudoers.d/node-entrypoint && echo '✓ entrypoint sudoers exists'

            echo '=== All checks passed ==='
          "

      - name: Verify all feature tools are installed
        run: |
          devcontainer exec --workspace-folder . bash -c "
            echo '=== Verifying all feature tools ==='
            FAILED=0

            # golang-lint
            if golangci-lint --version 2>/dev/null; then
              echo '✓ golangci-lint installed'
            else
              echo '✗ golangci-lint NOT found'
              FAILED=1
            fi

            # terraform
            if terraform --version 2>/dev/null; then
              echo '✓ terraform installed'
            else
              echo '✗ terraform NOT found'
              FAILED=1
            fi

            # helm
            if helm version --short 2>/dev/null; then
              echo '✓ helm installed'
            else
              echo '✗ helm NOT found'
              FAILED=1
            fi

            # kubectl
            if kubectl version --client 2>/dev/null; then
              echo '✓ kubectl installed'
            else
              echo '✗ kubectl NOT found'
              FAILED=1
            fi

            # kubectx/kubens
            if which kubectx && which kubens 2>/dev/null; then
              echo '✓ kubectx/kubens installed'
            else
              echo '✗ kubectx/kubens NOT found'
              FAILED=1
            fi

            # aws-cli
            if aws --version 2>/dev/null; then
              echo '✓ aws-cli installed'
            else
              echo '✗ aws-cli NOT found'
              FAILED=1
            fi

            # gcloud-cli
            if gcloud --version 2>/dev/null | head -1; then
              echo '✓ gcloud-cli installed'
            else
              echo '✗ gcloud-cli NOT found'
              FAILED=1
            fi

            # python-poetry-uv
            if poetry --version 2>/dev/null && uv --version 2>/dev/null; then
              echo '✓ poetry and uv installed'
            else
              echo '✗ poetry or uv NOT found'
              FAILED=1
            fi

            # redis-cli
            if redis-cli --version 2>/dev/null; then
              echo '✓ redis-cli installed'
            else
              echo '✗ redis-cli NOT found'
              FAILED=1
            fi

            # psql
            if psql --version 2>/dev/null; then
              echo '✓ psql installed'
            else
              echo '✗ psql NOT found'
              FAILED=1
            fi

            # argo-cli (argocd is default, argo workflows is optional)
            if argocd version --client 2>/dev/null; then
              echo '✓ argocd installed'
            else
              echo '✗ argocd NOT found'
              FAILED=1
            fi

            # cilium-cli
            if cilium version --client 2>/dev/null; then
              echo '✓ cilium-cli installed'
            else
              echo '✗ cilium-cli NOT found'
              FAILED=1
            fi

            # istio-cli
            if istioctl version --remote=false 2>/dev/null; then
              echo '✓ istioctl installed'
            else
              echo '✗ istioctl NOT found'
              FAILED=1
            fi

            # wireguard
            if wg --version 2>/dev/null || which wg 2>/dev/null; then
              echo '✓ wireguard installed'
            else
              echo '✗ wireguard NOT found'
              FAILED=1
            fi

            # ebpf (bpftool)
            if bpftool version 2>/dev/null; then
              echo '✓ bpftool installed'
            else
              echo '✗ bpftool NOT found'
              FAILED=1
            fi

            # proxy-dpi (mitmproxy)
            if mitmproxy --version 2>/dev/null; then
              echo '✓ mitmproxy installed'
            else
              echo '✗ mitmproxy NOT found'
              FAILED=1
            fi

            # wss (websocat)
            if websocat --version 2>/dev/null; then
              echo '✓ websocat installed'
            else
              echo '✗ websocat NOT found'
              FAILED=1
            fi

            echo '=== Tool verification complete ==='
            exit \$FAILED
          "

      - name: Get container ID
        id: container
        run: |
          CONTAINER_ID=$(docker ps -q --filter "label=devcontainer.local_folder=$PWD")
          echo "id=$CONTAINER_ID" >> $GITHUB_OUTPUT

      - name: Test firewall can be started
        run: |
          docker exec -u root ${{ steps.container.outputs.id }} bash -c "
            echo '=== Testing firewall start ==='
            source /etc/firewall.conf
            export FIREWALL_ALLOWED_DOMAINS FIREWALL_ALLOW_GITHUB FIREWALL_BLOCK_VERIFICATION_DOMAIN
            /usr/local/bin/init-firewall.sh
            echo '✓ Firewall started successfully'

            echo '=== Firewall status ==='
            iptables -L -n | head -20

            echo '=== Allowed IPs (sample) ==='
            ipset list allowed-domains | head -20
          "

      - name: Test firewall blocks unauthorized traffic
        run: |
          docker exec -u node ${{ steps.container.outputs.id }} bash -c "
            echo '=== Testing firewall blocking ==='

            # This should fail (blocked)
            if curl --connect-timeout 5 https://example.com 2>/dev/null; then
              echo '✗ ERROR: Firewall should have blocked example.com'
              exit 1
            else
              echo '✓ example.com blocked as expected'
            fi

            # This should succeed (allowed)
            if curl --connect-timeout 10 https://api.github.com/zen 2>/dev/null; then
              echo '✓ api.github.com accessible as expected'
            else
              echo '⚠ Warning: api.github.com not accessible (may be rate limited)'
            fi

            echo '=== Firewall verification passed ==='
          "

      - name: Cleanup
        if: always()
        run: |
          # Stop any running containers from this devcontainer
          docker ps -q --filter "label=devcontainer.local_folder=$PWD" | xargs -r docker stop || true
